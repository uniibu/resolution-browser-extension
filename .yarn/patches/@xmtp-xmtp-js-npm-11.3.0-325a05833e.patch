diff --git a/dist/web/index.js b/dist/web/index.js
index 721b5df2f310c29958772548e7b71ef312f9159e..d6fcd0ce45df366bc52c53e8b4b31cf8377fe3b7 100644
--- a/dist/web/index.js
+++ b/dist/web/index.js
@@ -6,7 +6,7 @@ import { Mutex } from 'async-mutex';
 import ao from 'elliptic';
 import hn, { user_preferences_encrypt, user_preferences_decrypt, generate_private_preferences_topic } from '@xmtp/user-preferences-bindings-wasm/web';
 
-var ni=Object.create;var Dn=Object.defineProperty;var si=Object.getOwnPropertyDescriptor;var ii=Object.getOwnPropertyNames;var oi=Object.getPrototypeOf,ai=Object.prototype.hasOwnProperty;var ci=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var pi=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ii(e))!ai.call(n,s)&&s!==t&&Dn(n,s,{get:()=>e[s],enumerable:!(r=si(e,s))||r.enumerable});return n};var di=(n,e,t)=>(t=n!=null?ni(oi(n)):{},pi(e||!n||!n.__esModule?Dn(t,"default",{value:n,enumerable:!0}):t,n));var ys=ci((Dp,Nr)=>{(function(){var n="input is invalid type",e="finalize already called",t=typeof window=="object",r=t?window:{};r.JS_SHA3_NO_WINDOW&&(t=!1);var s=!t&&typeof self=="object",o=!r.JS_SHA3_NO_NODE_JS&&typeof process=="object"&&process.versions&&process.versions.node;o?r=global:s&&(r=self);var a=!r.JS_SHA3_NO_COMMON_JS&&typeof Nr=="object"&&Nr.exports,c=typeof define=="function"&&define.amd,p=!r.JS_SHA3_NO_ARRAY_BUFFER&&typeof ArrayBuffer<"u",d="0123456789abcdef".split(""),f=[31,7936,2031616,520093696],w=[4,1024,262144,67108864],A=[1,256,65536,16777216],se=[6,1536,393216,100663296],D=[0,8,16,24],Ke=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],it=[224,256,384,512],$e=[128,256],An=["hex","buffer","arrayBuffer","array","digest"],Tn={128:168,256:136};(r.JS_SHA3_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(i){return Object.prototype.toString.call(i)==="[object Array]"}),p&&(r.JS_SHA3_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(i){return typeof i=="object"&&i.buffer&&i.buffer.constructor===ArrayBuffer});for(var En=function(i,u,y){return function(l){return new k(i,u,i).update(l)[y]()}},Sn=function(i,u,y){return function(l,m){return new k(i,u,m).update(l)[y]()}},xn=function(i,u,y){return function(l,m,g,v){return ge["cshake"+i].update(l,m,g,v)[y]()}},kn=function(i,u,y){return function(l,m,g,v){return ge["kmac"+i].update(l,m,g,v)[y]()}},Ct=function(i,u,y,l){for(var m=0;m<An.length;++m){var g=An[m];i[g]=u(y,l,g);}return i},Bn=function(i,u){var y=En(i,u,"hex");return y.create=function(){return new k(i,u,i)},y.update=function(l){return y.create().update(l)},Ct(y,En,i,u)},ei=function(i,u){var y=Sn(i,u,"hex");return y.create=function(l){return new k(i,u,l)},y.update=function(l,m){return y.create(m).update(l)},Ct(y,Sn,i,u)},ti=function(i,u){var y=Tn[i],l=xn(i,u,"hex");return l.create=function(m,g,v){return !g&&!v?ge["shake"+i].create(m):new k(i,u,m).bytepad([g,v],y)},l.update=function(m,g,v,h){return l.create(g,v,h).update(m)},Ct(l,xn,i,u)},ri=function(i,u){var y=Tn[i],l=kn(i,u,"hex");return l.create=function(m,g,v){return new jr(i,u,g).bytepad(["KMAC",v],y).bytepad([m],y)},l.update=function(m,g,v,h){return l.create(m,v,h).update(g)},Ct(l,kn,i,u)},Mn=[{name:"keccak",padding:A,bits:it,createMethod:Bn},{name:"sha3",padding:se,bits:it,createMethod:Bn},{name:"shake",padding:f,bits:$e,createMethod:ei},{name:"cshake",padding:w,bits:$e,createMethod:ti},{name:"kmac",padding:w,bits:$e,createMethod:ri}],ge={},ot=[],Ae=0;Ae<Mn.length;++Ae)for(var ze=Mn[Ae],Kt=ze.bits,at=0;at<Kt.length;++at){var Jr=ze.name+"_"+Kt[at];if(ot.push(Jr),ge[Jr]=ze.createMethod(Kt[at],ze.padding),ze.name!=="sha3"){var Rn=ze.name+Kt[at];ot.push(Rn),ge[Rn]=ge[Jr];}}function k(i,u,y){this.blocks=[],this.s=[],this.padding=u,this.outputBits=y,this.reset=!0,this.finalized=!1,this.block=0,this.start=0,this.blockCount=1600-(i<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=y>>5,this.extraBytes=(y&31)>>3;for(var l=0;l<50;++l)this.s[l]=0;}k.prototype.update=function(i){if(this.finalized)throw new Error(e);var u,y=typeof i;if(y!=="string"){if(y==="object"){if(i===null)throw new Error(n);if(p&&i.constructor===ArrayBuffer)i=new Uint8Array(i);else if(!Array.isArray(i)&&(!p||!ArrayBuffer.isView(i)))throw new Error(n)}else throw new Error(n);u=!0;}for(var l=this.blocks,m=this.byteCount,g=i.length,v=this.blockCount,h=0,B=this.s,b,E;h<g;){if(this.reset)for(this.reset=!1,l[0]=this.block,b=1;b<v+1;++b)l[b]=0;if(u)for(b=this.start;h<g&&b<m;++h)l[b>>2]|=i[h]<<D[b++&3];else for(b=this.start;h<g&&b<m;++h)E=i.charCodeAt(h),E<128?l[b>>2]|=E<<D[b++&3]:E<2048?(l[b>>2]|=(192|E>>6)<<D[b++&3],l[b>>2]|=(128|E&63)<<D[b++&3]):E<55296||E>=57344?(l[b>>2]|=(224|E>>12)<<D[b++&3],l[b>>2]|=(128|E>>6&63)<<D[b++&3],l[b>>2]|=(128|E&63)<<D[b++&3]):(E=65536+((E&1023)<<10|i.charCodeAt(++h)&1023),l[b>>2]|=(240|E>>18)<<D[b++&3],l[b>>2]|=(128|E>>12&63)<<D[b++&3],l[b>>2]|=(128|E>>6&63)<<D[b++&3],l[b>>2]|=(128|E&63)<<D[b++&3]);if(this.lastByteIndex=b,b>=m){for(this.start=b-m,this.block=l[v],b=0;b<v;++b)B[b]^=l[b];ct(B),this.reset=!0;}else this.start=b;}return this},k.prototype.encode=function(i,u){var y=i&255,l=1,m=[y];for(i=i>>8,y=i&255;y>0;)m.unshift(y),i=i>>8,y=i&255,++l;return u?m.push(l):m.unshift(l),this.update(m),m.length},k.prototype.encodeString=function(i){var u,y=typeof i;if(y!=="string"){if(y==="object"){if(i===null)throw new Error(n);if(p&&i.constructor===ArrayBuffer)i=new Uint8Array(i);else if(!Array.isArray(i)&&(!p||!ArrayBuffer.isView(i)))throw new Error(n)}else throw new Error(n);u=!0;}var l=0,m=i.length;if(u)l=m;else for(var g=0;g<i.length;++g){var v=i.charCodeAt(g);v<128?l+=1:v<2048?l+=2:v<55296||v>=57344?l+=3:(v=65536+((v&1023)<<10|i.charCodeAt(++g)&1023),l+=4);}return l+=this.encode(l*8),this.update(i),l},k.prototype.bytepad=function(i,u){for(var y=this.encode(u),l=0;l<i.length;++l)y+=this.encodeString(i[l]);var m=u-y%u,g=[];return g.length=m,this.update(g),this},k.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var i=this.blocks,u=this.lastByteIndex,y=this.blockCount,l=this.s;if(i[u>>2]|=this.padding[u&3],this.lastByteIndex===this.byteCount)for(i[0]=i[y],u=1;u<y+1;++u)i[u]=0;for(i[y-1]|=2147483648,u=0;u<y;++u)l[u]^=i[u];ct(l);}},k.prototype.toString=k.prototype.hex=function(){this.finalize();for(var i=this.blockCount,u=this.s,y=this.outputBlocks,l=this.extraBytes,m=0,g=0,v="",h;g<y;){for(m=0;m<i&&g<y;++m,++g)h=u[m],v+=d[h>>4&15]+d[h&15]+d[h>>12&15]+d[h>>8&15]+d[h>>20&15]+d[h>>16&15]+d[h>>28&15]+d[h>>24&15];g%i===0&&(ct(u),m=0);}return l&&(h=u[m],v+=d[h>>4&15]+d[h&15],l>1&&(v+=d[h>>12&15]+d[h>>8&15]),l>2&&(v+=d[h>>20&15]+d[h>>16&15])),v},k.prototype.arrayBuffer=function(){this.finalize();var i=this.blockCount,u=this.s,y=this.outputBlocks,l=this.extraBytes,m=0,g=0,v=this.outputBits>>3,h;l?h=new ArrayBuffer(y+1<<2):h=new ArrayBuffer(v);for(var B=new Uint32Array(h);g<y;){for(m=0;m<i&&g<y;++m,++g)B[g]=u[m];g%i===0&&ct(u);}return l&&(B[m]=u[m],h=h.slice(0,v)),h},k.prototype.buffer=k.prototype.arrayBuffer,k.prototype.digest=k.prototype.array=function(){this.finalize();for(var i=this.blockCount,u=this.s,y=this.outputBlocks,l=this.extraBytes,m=0,g=0,v=[],h,B;g<y;){for(m=0;m<i&&g<y;++m,++g)h=g<<2,B=u[m],v[h]=B&255,v[h+1]=B>>8&255,v[h+2]=B>>16&255,v[h+3]=B>>24&255;g%i===0&&ct(u);}return l&&(h=g<<2,B=u[m],v[h]=B&255,l>1&&(v[h+1]=B>>8&255),l>2&&(v[h+2]=B>>16&255)),v};function jr(i,u,y){k.call(this,i,u,y);}jr.prototype=new k,jr.prototype.finalize=function(){return this.encode(this.outputBits,!0),k.prototype.finalize.call(this)};var ct=function(i){var u,y,l,m,g,v,h,B,b,E,At,Tt,Et,St,xt,kt,Bt,Mt,Rt,Dt,It,Ut,Vt,Nt,Ot,_t,Lt,qt,Ft,Ht,Jt,jt,Gt,Wt,Xt,$t,zt,Qt,Yt,Zt,er,tr,rr,nr,sr,ir,or,ar,cr,pr,dr,ur,yr,lr,mr,fr,hr,gr,vr,wr,br,Pr,Cr;for(l=0;l<48;l+=2)m=i[0]^i[10]^i[20]^i[30]^i[40],g=i[1]^i[11]^i[21]^i[31]^i[41],v=i[2]^i[12]^i[22]^i[32]^i[42],h=i[3]^i[13]^i[23]^i[33]^i[43],B=i[4]^i[14]^i[24]^i[34]^i[44],b=i[5]^i[15]^i[25]^i[35]^i[45],E=i[6]^i[16]^i[26]^i[36]^i[46],At=i[7]^i[17]^i[27]^i[37]^i[47],Tt=i[8]^i[18]^i[28]^i[38]^i[48],Et=i[9]^i[19]^i[29]^i[39]^i[49],u=Tt^(v<<1|h>>>31),y=Et^(h<<1|v>>>31),i[0]^=u,i[1]^=y,i[10]^=u,i[11]^=y,i[20]^=u,i[21]^=y,i[30]^=u,i[31]^=y,i[40]^=u,i[41]^=y,u=m^(B<<1|b>>>31),y=g^(b<<1|B>>>31),i[2]^=u,i[3]^=y,i[12]^=u,i[13]^=y,i[22]^=u,i[23]^=y,i[32]^=u,i[33]^=y,i[42]^=u,i[43]^=y,u=v^(E<<1|At>>>31),y=h^(At<<1|E>>>31),i[4]^=u,i[5]^=y,i[14]^=u,i[15]^=y,i[24]^=u,i[25]^=y,i[34]^=u,i[35]^=y,i[44]^=u,i[45]^=y,u=B^(Tt<<1|Et>>>31),y=b^(Et<<1|Tt>>>31),i[6]^=u,i[7]^=y,i[16]^=u,i[17]^=y,i[26]^=u,i[27]^=y,i[36]^=u,i[37]^=y,i[46]^=u,i[47]^=y,u=E^(m<<1|g>>>31),y=At^(g<<1|m>>>31),i[8]^=u,i[9]^=y,i[18]^=u,i[19]^=y,i[28]^=u,i[29]^=y,i[38]^=u,i[39]^=y,i[48]^=u,i[49]^=y,St=i[0],xt=i[1],ir=i[11]<<4|i[10]>>>28,or=i[10]<<4|i[11]>>>28,qt=i[20]<<3|i[21]>>>29,Ft=i[21]<<3|i[20]>>>29,wr=i[31]<<9|i[30]>>>23,br=i[30]<<9|i[31]>>>23,tr=i[40]<<18|i[41]>>>14,rr=i[41]<<18|i[40]>>>14,Wt=i[2]<<1|i[3]>>>31,Xt=i[3]<<1|i[2]>>>31,kt=i[13]<<12|i[12]>>>20,Bt=i[12]<<12|i[13]>>>20,ar=i[22]<<10|i[23]>>>22,cr=i[23]<<10|i[22]>>>22,Ht=i[33]<<13|i[32]>>>19,Jt=i[32]<<13|i[33]>>>19,Pr=i[42]<<2|i[43]>>>30,Cr=i[43]<<2|i[42]>>>30,lr=i[5]<<30|i[4]>>>2,mr=i[4]<<30|i[5]>>>2,$t=i[14]<<6|i[15]>>>26,zt=i[15]<<6|i[14]>>>26,Mt=i[25]<<11|i[24]>>>21,Rt=i[24]<<11|i[25]>>>21,pr=i[34]<<15|i[35]>>>17,dr=i[35]<<15|i[34]>>>17,jt=i[45]<<29|i[44]>>>3,Gt=i[44]<<29|i[45]>>>3,Nt=i[6]<<28|i[7]>>>4,Ot=i[7]<<28|i[6]>>>4,fr=i[17]<<23|i[16]>>>9,hr=i[16]<<23|i[17]>>>9,Qt=i[26]<<25|i[27]>>>7,Yt=i[27]<<25|i[26]>>>7,Dt=i[36]<<21|i[37]>>>11,It=i[37]<<21|i[36]>>>11,ur=i[47]<<24|i[46]>>>8,yr=i[46]<<24|i[47]>>>8,nr=i[8]<<27|i[9]>>>5,sr=i[9]<<27|i[8]>>>5,_t=i[18]<<20|i[19]>>>12,Lt=i[19]<<20|i[18]>>>12,gr=i[29]<<7|i[28]>>>25,vr=i[28]<<7|i[29]>>>25,Zt=i[38]<<8|i[39]>>>24,er=i[39]<<8|i[38]>>>24,Ut=i[48]<<14|i[49]>>>18,Vt=i[49]<<14|i[48]>>>18,i[0]=St^~kt&Mt,i[1]=xt^~Bt&Rt,i[10]=Nt^~_t&qt,i[11]=Ot^~Lt&Ft,i[20]=Wt^~$t&Qt,i[21]=Xt^~zt&Yt,i[30]=nr^~ir&ar,i[31]=sr^~or&cr,i[40]=lr^~fr&gr,i[41]=mr^~hr&vr,i[2]=kt^~Mt&Dt,i[3]=Bt^~Rt&It,i[12]=_t^~qt&Ht,i[13]=Lt^~Ft&Jt,i[22]=$t^~Qt&Zt,i[23]=zt^~Yt&er,i[32]=ir^~ar&pr,i[33]=or^~cr&dr,i[42]=fr^~gr&wr,i[43]=hr^~vr&br,i[4]=Mt^~Dt&Ut,i[5]=Rt^~It&Vt,i[14]=qt^~Ht&jt,i[15]=Ft^~Jt&Gt,i[24]=Qt^~Zt&tr,i[25]=Yt^~er&rr,i[34]=ar^~pr&ur,i[35]=cr^~dr&yr,i[44]=gr^~wr&Pr,i[45]=vr^~br&Cr,i[6]=Dt^~Ut&St,i[7]=It^~Vt&xt,i[16]=Ht^~jt&Nt,i[17]=Jt^~Gt&Ot,i[26]=Zt^~tr&Wt,i[27]=er^~rr&Xt,i[36]=pr^~ur&nr,i[37]=dr^~yr&sr,i[46]=wr^~Pr&lr,i[47]=br^~Cr&mr,i[8]=Ut^~St&kt,i[9]=Vt^~xt&Bt,i[18]=jt^~Nt&_t,i[19]=Gt^~Ot&Lt,i[28]=tr^~Wt&$t,i[29]=rr^~Xt&zt,i[38]=ur^~nr&ir,i[39]=yr^~sr&or,i[48]=Pr^~lr&fr,i[49]=Cr^~mr&hr,i[0]^=Ke[l],i[1]^=Ke[l+1];};if(a)Nr.exports=ge;else {for(Ae=0;Ae<ot.length;++Ae)r[ot[Ae]]=ge[ot[Ae]];c&&define(function(){return ge});}})();});var Te=n=>`/xmtp/0/${n}/proto`,ie=(n,e)=>{let t=[utils.getAddress(n),utils.getAddress(e)];return t.sort(),Te(`dm-${t.join("-")}`)},dt=n=>Te(`m-${n}`),ut=n=>Te(`contact-${utils.getAddress(n)}`),de=n=>Te(`intro-${utils.getAddress(n)}`),Ee=n=>Te(`invite-${utils.getAddress(n)}`),Gr=n=>Te(`privatestore-${n}`),Kr=n=>Te(`userpreferences-${n}`),Wr=n=>{let e=/^[\x21-\x7F]+$/,t=n.indexOf("0/");if(t!==-1){let r=n.substring(t+2,n.lastIndexOf("/proto"));return e.test(r)}return !1};var Ar=n=>new Promise(e=>setTimeout(e,n));var ui=n=>!!n;async function Qe(n,e,t,r,s=ui,o=1){let a=typeof o=="number"?o:1;try{return await n(...e)}catch(c){if(!s(c)||a>t)throw c;return await Ar(r),Qe(n,e,t,r,s,a+1)}}async function*Xr(n,e){for await(let t of n){let r=await Promise.allSettled(t.map(e)),s=[];for(let o of r)o.status==="fulfilled"?s.push(o.value):console.warn("Failed to process envelope due to reason: ",o.reason);yield s;}}function R(n){return In.fromNumber(n.valueOf()).multiply(1e6)}function H(n){return new Date(n.divide(1e6).toNumber())}var ue=n=>n&&R(n).toString(),$r=n=>{if(n)return H(In.fromString(n))};var{b64Decode:Tr,b64Encode:Un}=fetcher;function zr(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Vn(n){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,n,!0),new Uint8Array(e)}function Nn(n){let e=n.buffer;return new DataView(e).getInt32(0,!0)}var On=()=>typeof window<"u"&&typeof window.document<"u";function Er(n){let[e,t,...r]=n.split(".");return {major:Number(e),minor:Number(t),patch:r.join(".")}}function _n(n,e){return !n||!e?!0:Er(n).major===Er(e).major}function Ln(n,e){if(!n||!e)return !1;let t=Er(n),r=Er(e);return t.major!==r.major?t.major>r.major:t.minor!==r.minor?t.minor>r.minor:!t.patch||!r.patch?!1:li(t.patch,r.patch)}function li(n,e){let[t,r]=n.split("-"),[s,o]=e.split("-");if(Number(t)!==Number(s))return Number(t)>Number(s);if(!r||!o)return !1;let[a,c]=r.split("."),[p,d]=o.split(".");return a!==p?!0:Number(c)>Number(d)}function Qr(n){if(!n)return null;if(mi(n))return fi(n);if(typeof n.getAddress!="function")throw new Error("Unknown wallet type");return n}function mi(n){return "type"in n&&n.type==="walletClient"}function fi(n){let{account:e}=n;if(!e||!e.address)throw new Error("WalletClient is not configured");return {getAddress:async()=>e.address,signMessage:async t=>n.signMessage({message:typeof t=="string"?t:{raw:t},account:e})}}var L=class{topics;client;messages;resolvers;callback;subscriptionManager;onConnectionLost;constructor(e,t,r,s,o){this.messages=[],this.resolvers=[],this.topics=t,this.client=e,this.callback=this.newMessageCallback(r,s),this.onConnectionLost=o;}newMessageCallback(e,t){return async r=>{if(r.message)try{let s=await e(r);if(!s)return;if(t){let a=t(s);a&&this.resubscribeToTopics(a);}let o=this.resolvers.pop();o?o({value:s}):this.messages.unshift(s);}catch(s){console.warn(s);}}}async start(){if(!this.callback)throw new Error("Missing callback for stream");this.subscriptionManager=this.client.apiClient.subscribe({contentTopics:this.topics},async e=>{this.callback&&await this?.callback(e);},this.onConnectionLost);}static async create(e,t,r,s,o){let a=new L(e,t,r,s,o);return await a.start(),a}[Symbol.asyncIterator](){return this}async return(){return this.subscriptionManager&&await this.subscriptionManager.unsubscribe(),this.callback?(this.callback=void 0,this.resolvers.forEach(e=>e({value:void 0,done:!0})),{value:void 0,done:!0}):{value:void 0,done:!0}}next(){let e=this.messages.pop();return e?Promise.resolve({value:e}):this.callback?new Promise(t=>this.resolvers.unshift(t)):Promise.resolve({value:void 0,done:!0})}async resubscribeToTopics(e){if(!this.callback||!this.subscriptionManager)throw new Error("Missing callback for stream");if(typeof this.subscriptionManager?.updateContentTopics=="function")return this.subscriptionManager.updateContentTopics(e);await this.subscriptionManager.unsubscribe(),this.topics=e,this.subscriptionManager=this.client.apiClient.subscribe({contentTopics:this.topics},async t=>{this.callback&&await this?.callback(t);},this.onConnectionLost);}};var Yr=32,Zr=12,hi=16,U=class{aes256GcmHkdfSha256;constructor(e){if(!e.aes256GcmHkdfSha256)throw new Error("invalid ciphertext");if(e.aes256GcmHkdfSha256.payload.length<hi)throw new Error(`invalid ciphertext ciphertext length: ${e.aes256GcmHkdfSha256.payload.length}`);if(e.aes256GcmHkdfSha256.hkdfSalt.length!==Yr)throw new Error(`invalid ciphertext salt length: ${e.aes256GcmHkdfSha256.hkdfSalt.length}`);if(e.aes256GcmHkdfSha256.gcmNonce.length!==Zr)throw new Error(`invalid ciphertext nonce length: ${e.aes256GcmHkdfSha256.gcmNonce.length}`);this.aes256GcmHkdfSha256=e.aes256GcmHkdfSha256;}toBytes(){return ciphertext.Ciphertext.encode(this).finish()}static fromBytes(e){return new U(ciphertext.Ciphertext.decode(e))}};var gi=window.crypto,M=gi;var vi=new ArrayBuffer(0);async function V(n){return new Uint8Array(await M.subtle.digest("SHA-256",n))}async function ee(n,e,t){let r=M.getRandomValues(new Uint8Array(Yr)),s=M.getRandomValues(new Uint8Array(Zr)),o=await Hn(e,r),a=await M.subtle.encrypt(Fn(s,t),o,n);return new U({aes256GcmHkdfSha256:{payload:new Uint8Array(a),hkdfSalt:r,gcmNonce:s}})}async function X(n,e,t){if(!n.aes256GcmHkdfSha256)throw new Error("invalid payload ciphertext");let r=await Hn(e,n.aes256GcmHkdfSha256.hkdfSalt),s=await M.subtle.decrypt(Fn(n.aes256GcmHkdfSha256.gcmNonce,t),r,n.aes256GcmHkdfSha256.payload);return new Uint8Array(s)}function Fn(n,e){let t={name:"AES-GCM",iv:n};return e&&(t.additionalData=e),t}async function Hn(n,e){let t=await M.subtle.importKey("raw",n,"HKDF",!1,["deriveKey"]);return M.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:e,info:vi},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}var $=j.utils.bytesToHex;function z(n){n.startsWith("0x")&&(n=n.slice(2));let e=new Uint8Array(n.length/2);for(let t=0;t<e.length;t++){let r=t*2;e[t]=Number.parseInt(n.slice(r,r+2),16);}return e}function Se(n,e){if(n.length!==e.length)return !1;for(let t=0;t<n.length;t++)if(n[t]!==e[t])return !1;return !0}function Gn(n){if(n.bytes.length!==32)throw new Error(`invalid private key length: ${n.bytes.length}`)}var q=class{createdNs;secp256k1;publicKey;constructor(e){if(!e.secp256k1)throw new Error("invalid private key");if(Gn(e.secp256k1),this.secp256k1=e.secp256k1,this.createdNs=e.createdNs,!e.publicKey)throw new Error("missing public key");this.publicKey=new S(e.publicKey);}static async generate(e){let t={bytes:j.utils.randomPrivateKey()},r=In.fromNumber(new Date().getTime()).mul(1e6),s=new re({secp256k1Uncompressed:{bytes:j.getPublicKey(t.bytes)},createdNs:r}),o=await e.signKey(s);return new q({secp256k1:t,createdNs:r,publicKey:o})}generated(){return new Date(this.createdNs.div(1e6).toNumber())}async sign(e){let[t,r]=await j.sign(e,this.secp256k1.bytes,{recovered:!0,der:!1});return new x({ecdsaCompact:{bytes:t,recovery:r}})}async signKey(e){let t=e.toBytes(),r=await V(t),s=await this.sign(r);return new S({keyBytes:t,signature:s})}static async signerKey(e,t){let r=await V(e.bytesToSign());return en(r,t)}sharedSecret(e){return j.getSharedSecret(this.secp256k1.bytes,e.secp256k1Uncompressed.bytes,!1)}encrypt(e,t,r){let s=this.sharedSecret(t);return ee(e,s,r)}decrypt(e,t,r){let s=this.sharedSecret(t);return X(e,s,r)}matches(e){return this.publicKey.equals(e)}equals(e){return Se(this.secp256k1.bytes,e.secp256k1.bytes)&&this.publicKey.equals(e.publicKey)}toBytes(){return privateKey.SignedPrivateKey.encode(this).finish()}validatePublicKey(){let e=j.getPublicKey(this.secp256k1.bytes);return Se(e,this.publicKey.secp256k1Uncompressed.bytes)}static fromBytes(e){return new q(privateKey.SignedPrivateKey.decode(e))}static fromLegacyKey(e,t){return new q({createdNs:e.timestamp.mul(1e6),secp256k1:e.secp256k1,publicKey:S.fromLegacyKey(e.publicKey,t)})}},te=class{timestamp;secp256k1;publicKey;constructor(e){if(!e.secp256k1)throw new Error("invalid private key");if(Gn(e.secp256k1),this.timestamp=e.timestamp,this.secp256k1=e.secp256k1,!e.publicKey)throw new Error("missing public key");this.publicKey=new N(e.publicKey);}static generate(){let e={bytes:j.utils.randomPrivateKey()},t=In.fromNumber(new Date().getTime());return new te({secp256k1:e,timestamp:t,publicKey:new N({secp256k1Uncompressed:{bytes:j.getPublicKey(e.bytes)},timestamp:t})})}generated(){return new Date(this.timestamp.toNumber())}async sign(e){let[t,r]=await j.sign(e,this.secp256k1.bytes,{recovered:!0,der:!1});return new x({ecdsaCompact:{bytes:t,recovery:r}})}async signKey(e){let t=await V(e.bytesToSign());return e.signature=await this.sign(t),e}sharedSecret(e){return j.getSharedSecret(this.secp256k1.bytes,e.secp256k1Uncompressed.bytes,!1)}encrypt(e,t,r){let s=this.sharedSecret(t);return ee(e,s,r)}decrypt(e,t,r){let s=this.sharedSecret(t);return X(e,s,r)}matches(e){return this.publicKey.equals(e)}validatePublicKey(){let e=j.getPublicKey(this.secp256k1.bytes);return Se(e,this.publicKey.secp256k1Uncompressed.bytes)}toBytes(){return privateKey.PrivateKey.encode(this).finish()}static fromBytes(e){return new te(privateKey.PrivateKey.decode(e))}};function $n(n){if(n.bytes.length!==64)throw new Error(`invalid signature length: ${n.bytes.length}`);if(n.recovery!==0&&n.recovery!==1)throw new Error(`invalid recovery bit: ${n.recovery}`)}function zn(n,e){return n.recovery===e.recovery&&Se(n.bytes,e.bytes)}function en(n,e){let t=j.recoverPublicKey(n,e.bytes,e.recovery);return t?new re({secp256k1Uncompressed:{bytes:t},createdNs:In.fromNumber(0)}):void 0}var x=class{ecdsaCompact;walletEcdsaCompact;constructor(e){if(e.ecdsaCompact)$n(e.ecdsaCompact),this.ecdsaCompact=e.ecdsaCompact;else if(e.walletEcdsaCompact)$n(e.walletEcdsaCompact),this.walletEcdsaCompact=e.walletEcdsaCompact;else throw new Error("invalid signature")}async signerKey(e){return this.ecdsaCompact?q.signerKey(e,this.ecdsaCompact):this.walletEcdsaCompact?oe.signerKey(e,this.walletEcdsaCompact):void 0}getPublicKey(e){let t;if(this.ecdsaCompact)t=j.recoverPublicKey(e,this.ecdsaCompact.bytes,this.ecdsaCompact.recovery);else if(this.walletEcdsaCompact)t=j.recoverPublicKey(e,this.walletEcdsaCompact.bytes,this.walletEcdsaCompact.recovery);else throw new Error("invalid v1 signature");return t?new N({secp256k1Uncompressed:{bytes:t},timestamp:In.fromNumber(0)}):void 0}equals(e){return this.ecdsaCompact&&e.ecdsaCompact?zn(this.ecdsaCompact,e.ecdsaCompact):this.walletEcdsaCompact&&e.walletEcdsaCompact?zn(this.walletEcdsaCompact,e.walletEcdsaCompact):!1}toBytes(){return signature.Signature.encode(this).finish()}static fromBytes(e){return new x(signature.Signature.decode(e))}};var oe=class{wallet;constructor(e){this.wallet=e;}static identitySigRequestText(e){return `XMTP : Create Identity
+var ni=Object.create;var Dn=Object.defineProperty;var si=Object.getOwnPropertyDescriptor;var ii=Object.getOwnPropertyNames;var oi=Object.getPrototypeOf,ai=Object.prototype.hasOwnProperty;var ci=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var pi=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ii(e))!ai.call(n,s)&&s!==t&&Dn(n,s,{get:()=>e[s],enumerable:!(r=si(e,s))||r.enumerable});return n};var di=(n,e,t)=>(t=n!=null?ni(oi(n)):{},pi(e||!n||!n.__esModule?Dn(t,"default",{value:n,enumerable:!0}):t,n));var ys=ci((Dp,Nr)=>{(function(){var n="input is invalid type",e="finalize already called",t=typeof window=="object",r=t?window:{};r.JS_SHA3_NO_WINDOW&&(t=!1);var s=!t&&typeof self=="object",o=!r.JS_SHA3_NO_NODE_JS&&typeof process=="object"&&process.versions&&process.versions.node;o?r=global:s&&(r=self);var a=!r.JS_SHA3_NO_COMMON_JS&&typeof Nr=="object"&&Nr.exports,c=typeof define=="function"&&define.amd,p=!r.JS_SHA3_NO_ARRAY_BUFFER&&typeof ArrayBuffer<"u",d="0123456789abcdef".split(""),f=[31,7936,2031616,520093696],w=[4,1024,262144,67108864],A=[1,256,65536,16777216],se=[6,1536,393216,100663296],D=[0,8,16,24],Ke=[1,0,32898,0,32906,2147483648,2147516416,2147483648,32907,0,2147483649,0,2147516545,2147483648,32777,2147483648,138,0,136,0,2147516425,0,2147483658,0,2147516555,0,139,2147483648,32905,2147483648,32771,2147483648,32770,2147483648,128,2147483648,32778,0,2147483658,2147483648,2147516545,2147483648,32896,2147483648,2147483649,0,2147516424,2147483648],it=[224,256,384,512],$e=[128,256],An=["hex","buffer","arrayBuffer","array","digest"],Tn={128:168,256:136};(r.JS_SHA3_NO_NODE_JS||!Array.isArray)&&(Array.isArray=function(i){return Object.prototype.toString.call(i)==="[object Array]"}),p&&(r.JS_SHA3_NO_ARRAY_BUFFER_IS_VIEW||!ArrayBuffer.isView)&&(ArrayBuffer.isView=function(i){return typeof i=="object"&&i.buffer&&i.buffer.constructor===ArrayBuffer});for(var En=function(i,u,y){return function(l){return new k(i,u,i).update(l)[y]()}},Sn=function(i,u,y){return function(l,m){return new k(i,u,m).update(l)[y]()}},xn=function(i,u,y){return function(l,m,g,v){return ge["cshake"+i].update(l,m,g,v)[y]()}},kn=function(i,u,y){return function(l,m,g,v){return ge["kmac"+i].update(l,m,g,v)[y]()}},Ct=function(i,u,y,l){for(var m=0;m<An.length;++m){var g=An[m];i[g]=u(y,l,g);}return i},Bn=function(i,u){var y=En(i,u,"hex");return y.create=function(){return new k(i,u,i)},y.update=function(l){return y.create().update(l)},Ct(y,En,i,u)},ei=function(i,u){var y=Sn(i,u,"hex");return y.create=function(l){return new k(i,u,l)},y.update=function(l,m){return y.create(m).update(l)},Ct(y,Sn,i,u)},ti=function(i,u){var y=Tn[i],l=xn(i,u,"hex");return l.create=function(m,g,v){return !g&&!v?ge["shake"+i].create(m):new k(i,u,m).bytepad([g,v],y)},l.update=function(m,g,v,h){return l.create(g,v,h).update(m)},Ct(l,xn,i,u)},ri=function(i,u){var y=Tn[i],l=kn(i,u,"hex");return l.create=function(m,g,v){return new jr(i,u,g).bytepad(["KMAC",v],y).bytepad([m],y)},l.update=function(m,g,v,h){return l.create(m,v,h).update(g)},Ct(l,kn,i,u)},Mn=[{name:"keccak",padding:A,bits:it,createMethod:Bn},{name:"sha3",padding:se,bits:it,createMethod:Bn},{name:"shake",padding:f,bits:$e,createMethod:ei},{name:"cshake",padding:w,bits:$e,createMethod:ti},{name:"kmac",padding:w,bits:$e,createMethod:ri}],ge={},ot=[],Ae=0;Ae<Mn.length;++Ae)for(var ze=Mn[Ae],Kt=ze.bits,at=0;at<Kt.length;++at){var Jr=ze.name+"_"+Kt[at];if(ot.push(Jr),ge[Jr]=ze.createMethod(Kt[at],ze.padding),ze.name!=="sha3"){var Rn=ze.name+Kt[at];ot.push(Rn),ge[Rn]=ge[Jr];}}function k(i,u,y){this.blocks=[],this.s=[],this.padding=u,this.outputBits=y,this.reset=!0,this.finalized=!1,this.block=0,this.start=0,this.blockCount=1600-(i<<1)>>5,this.byteCount=this.blockCount<<2,this.outputBlocks=y>>5,this.extraBytes=(y&31)>>3;for(var l=0;l<50;++l)this.s[l]=0;}k.prototype.update=function(i){if(this.finalized)throw new Error(e);var u,y=typeof i;if(y!=="string"){if(y==="object"){if(i===null)throw new Error(n);if(p&&i.constructor===ArrayBuffer)i=new Uint8Array(i);else if(!Array.isArray(i)&&(!p||!ArrayBuffer.isView(i)))throw new Error(n)}else throw new Error(n);u=!0;}for(var l=this.blocks,m=this.byteCount,g=i.length,v=this.blockCount,h=0,B=this.s,b,E;h<g;){if(this.reset)for(this.reset=!1,l[0]=this.block,b=1;b<v+1;++b)l[b]=0;if(u)for(b=this.start;h<g&&b<m;++h)l[b>>2]|=i[h]<<D[b++&3];else for(b=this.start;h<g&&b<m;++h)E=i.charCodeAt(h),E<128?l[b>>2]|=E<<D[b++&3]:E<2048?(l[b>>2]|=(192|E>>6)<<D[b++&3],l[b>>2]|=(128|E&63)<<D[b++&3]):E<55296||E>=57344?(l[b>>2]|=(224|E>>12)<<D[b++&3],l[b>>2]|=(128|E>>6&63)<<D[b++&3],l[b>>2]|=(128|E&63)<<D[b++&3]):(E=65536+((E&1023)<<10|i.charCodeAt(++h)&1023),l[b>>2]|=(240|E>>18)<<D[b++&3],l[b>>2]|=(128|E>>12&63)<<D[b++&3],l[b>>2]|=(128|E>>6&63)<<D[b++&3],l[b>>2]|=(128|E&63)<<D[b++&3]);if(this.lastByteIndex=b,b>=m){for(this.start=b-m,this.block=l[v],b=0;b<v;++b)B[b]^=l[b];ct(B),this.reset=!0;}else this.start=b;}return this},k.prototype.encode=function(i,u){var y=i&255,l=1,m=[y];for(i=i>>8,y=i&255;y>0;)m.unshift(y),i=i>>8,y=i&255,++l;return u?m.push(l):m.unshift(l),this.update(m),m.length},k.prototype.encodeString=function(i){var u,y=typeof i;if(y!=="string"){if(y==="object"){if(i===null)throw new Error(n);if(p&&i.constructor===ArrayBuffer)i=new Uint8Array(i);else if(!Array.isArray(i)&&(!p||!ArrayBuffer.isView(i)))throw new Error(n)}else throw new Error(n);u=!0;}var l=0,m=i.length;if(u)l=m;else for(var g=0;g<i.length;++g){var v=i.charCodeAt(g);v<128?l+=1:v<2048?l+=2:v<55296||v>=57344?l+=3:(v=65536+((v&1023)<<10|i.charCodeAt(++g)&1023),l+=4);}return l+=this.encode(l*8),this.update(i),l},k.prototype.bytepad=function(i,u){for(var y=this.encode(u),l=0;l<i.length;++l)y+=this.encodeString(i[l]);var m=u-y%u,g=[];return g.length=m,this.update(g),this},k.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var i=this.blocks,u=this.lastByteIndex,y=this.blockCount,l=this.s;if(i[u>>2]|=this.padding[u&3],this.lastByteIndex===this.byteCount)for(i[0]=i[y],u=1;u<y+1;++u)i[u]=0;for(i[y-1]|=2147483648,u=0;u<y;++u)l[u]^=i[u];ct(l);}},k.prototype.toString=k.prototype.hex=function(){this.finalize();for(var i=this.blockCount,u=this.s,y=this.outputBlocks,l=this.extraBytes,m=0,g=0,v="",h;g<y;){for(m=0;m<i&&g<y;++m,++g)h=u[m],v+=d[h>>4&15]+d[h&15]+d[h>>12&15]+d[h>>8&15]+d[h>>20&15]+d[h>>16&15]+d[h>>28&15]+d[h>>24&15];g%i===0&&(ct(u),m=0);}return l&&(h=u[m],v+=d[h>>4&15]+d[h&15],l>1&&(v+=d[h>>12&15]+d[h>>8&15]),l>2&&(v+=d[h>>20&15]+d[h>>16&15])),v},k.prototype.arrayBuffer=function(){this.finalize();var i=this.blockCount,u=this.s,y=this.outputBlocks,l=this.extraBytes,m=0,g=0,v=this.outputBits>>3,h;l?h=new ArrayBuffer(y+1<<2):h=new ArrayBuffer(v);for(var B=new Uint32Array(h);g<y;){for(m=0;m<i&&g<y;++m,++g)B[g]=u[m];g%i===0&&ct(u);}return l&&(B[m]=u[m],h=h.slice(0,v)),h},k.prototype.buffer=k.prototype.arrayBuffer,k.prototype.digest=k.prototype.array=function(){this.finalize();for(var i=this.blockCount,u=this.s,y=this.outputBlocks,l=this.extraBytes,m=0,g=0,v=[],h,B;g<y;){for(m=0;m<i&&g<y;++m,++g)h=g<<2,B=u[m],v[h]=B&255,v[h+1]=B>>8&255,v[h+2]=B>>16&255,v[h+3]=B>>24&255;g%i===0&&ct(u);}return l&&(h=g<<2,B=u[m],v[h]=B&255,l>1&&(v[h+1]=B>>8&255),l>2&&(v[h+2]=B>>16&255)),v};function jr(i,u,y){k.call(this,i,u,y);}jr.prototype=new k,jr.prototype.finalize=function(){return this.encode(this.outputBits,!0),k.prototype.finalize.call(this)};var ct=function(i){var u,y,l,m,g,v,h,B,b,E,At,Tt,Et,St,xt,kt,Bt,Mt,Rt,Dt,It,Ut,Vt,Nt,Ot,_t,Lt,qt,Ft,Ht,Jt,jt,Gt,Wt,Xt,$t,zt,Qt,Yt,Zt,er,tr,rr,nr,sr,ir,or,ar,cr,pr,dr,ur,yr,lr,mr,fr,hr,gr,vr,wr,br,Pr,Cr;for(l=0;l<48;l+=2)m=i[0]^i[10]^i[20]^i[30]^i[40],g=i[1]^i[11]^i[21]^i[31]^i[41],v=i[2]^i[12]^i[22]^i[32]^i[42],h=i[3]^i[13]^i[23]^i[33]^i[43],B=i[4]^i[14]^i[24]^i[34]^i[44],b=i[5]^i[15]^i[25]^i[35]^i[45],E=i[6]^i[16]^i[26]^i[36]^i[46],At=i[7]^i[17]^i[27]^i[37]^i[47],Tt=i[8]^i[18]^i[28]^i[38]^i[48],Et=i[9]^i[19]^i[29]^i[39]^i[49],u=Tt^(v<<1|h>>>31),y=Et^(h<<1|v>>>31),i[0]^=u,i[1]^=y,i[10]^=u,i[11]^=y,i[20]^=u,i[21]^=y,i[30]^=u,i[31]^=y,i[40]^=u,i[41]^=y,u=m^(B<<1|b>>>31),y=g^(b<<1|B>>>31),i[2]^=u,i[3]^=y,i[12]^=u,i[13]^=y,i[22]^=u,i[23]^=y,i[32]^=u,i[33]^=y,i[42]^=u,i[43]^=y,u=v^(E<<1|At>>>31),y=h^(At<<1|E>>>31),i[4]^=u,i[5]^=y,i[14]^=u,i[15]^=y,i[24]^=u,i[25]^=y,i[34]^=u,i[35]^=y,i[44]^=u,i[45]^=y,u=B^(Tt<<1|Et>>>31),y=b^(Et<<1|Tt>>>31),i[6]^=u,i[7]^=y,i[16]^=u,i[17]^=y,i[26]^=u,i[27]^=y,i[36]^=u,i[37]^=y,i[46]^=u,i[47]^=y,u=E^(m<<1|g>>>31),y=At^(g<<1|m>>>31),i[8]^=u,i[9]^=y,i[18]^=u,i[19]^=y,i[28]^=u,i[29]^=y,i[38]^=u,i[39]^=y,i[48]^=u,i[49]^=y,St=i[0],xt=i[1],ir=i[11]<<4|i[10]>>>28,or=i[10]<<4|i[11]>>>28,qt=i[20]<<3|i[21]>>>29,Ft=i[21]<<3|i[20]>>>29,wr=i[31]<<9|i[30]>>>23,br=i[30]<<9|i[31]>>>23,tr=i[40]<<18|i[41]>>>14,rr=i[41]<<18|i[40]>>>14,Wt=i[2]<<1|i[3]>>>31,Xt=i[3]<<1|i[2]>>>31,kt=i[13]<<12|i[12]>>>20,Bt=i[12]<<12|i[13]>>>20,ar=i[22]<<10|i[23]>>>22,cr=i[23]<<10|i[22]>>>22,Ht=i[33]<<13|i[32]>>>19,Jt=i[32]<<13|i[33]>>>19,Pr=i[42]<<2|i[43]>>>30,Cr=i[43]<<2|i[42]>>>30,lr=i[5]<<30|i[4]>>>2,mr=i[4]<<30|i[5]>>>2,$t=i[14]<<6|i[15]>>>26,zt=i[15]<<6|i[14]>>>26,Mt=i[25]<<11|i[24]>>>21,Rt=i[24]<<11|i[25]>>>21,pr=i[34]<<15|i[35]>>>17,dr=i[35]<<15|i[34]>>>17,jt=i[45]<<29|i[44]>>>3,Gt=i[44]<<29|i[45]>>>3,Nt=i[6]<<28|i[7]>>>4,Ot=i[7]<<28|i[6]>>>4,fr=i[17]<<23|i[16]>>>9,hr=i[16]<<23|i[17]>>>9,Qt=i[26]<<25|i[27]>>>7,Yt=i[27]<<25|i[26]>>>7,Dt=i[36]<<21|i[37]>>>11,It=i[37]<<21|i[36]>>>11,ur=i[47]<<24|i[46]>>>8,yr=i[46]<<24|i[47]>>>8,nr=i[8]<<27|i[9]>>>5,sr=i[9]<<27|i[8]>>>5,_t=i[18]<<20|i[19]>>>12,Lt=i[19]<<20|i[18]>>>12,gr=i[29]<<7|i[28]>>>25,vr=i[28]<<7|i[29]>>>25,Zt=i[38]<<8|i[39]>>>24,er=i[39]<<8|i[38]>>>24,Ut=i[48]<<14|i[49]>>>18,Vt=i[49]<<14|i[48]>>>18,i[0]=St^~kt&Mt,i[1]=xt^~Bt&Rt,i[10]=Nt^~_t&qt,i[11]=Ot^~Lt&Ft,i[20]=Wt^~$t&Qt,i[21]=Xt^~zt&Yt,i[30]=nr^~ir&ar,i[31]=sr^~or&cr,i[40]=lr^~fr&gr,i[41]=mr^~hr&vr,i[2]=kt^~Mt&Dt,i[3]=Bt^~Rt&It,i[12]=_t^~qt&Ht,i[13]=Lt^~Ft&Jt,i[22]=$t^~Qt&Zt,i[23]=zt^~Yt&er,i[32]=ir^~ar&pr,i[33]=or^~cr&dr,i[42]=fr^~gr&wr,i[43]=hr^~vr&br,i[4]=Mt^~Dt&Ut,i[5]=Rt^~It&Vt,i[14]=qt^~Ht&jt,i[15]=Ft^~Jt&Gt,i[24]=Qt^~Zt&tr,i[25]=Yt^~er&rr,i[34]=ar^~pr&ur,i[35]=cr^~dr&yr,i[44]=gr^~wr&Pr,i[45]=vr^~br&Cr,i[6]=Dt^~Ut&St,i[7]=It^~Vt&xt,i[16]=Ht^~jt&Nt,i[17]=Jt^~Gt&Ot,i[26]=Zt^~tr&Wt,i[27]=er^~rr&Xt,i[36]=pr^~ur&nr,i[37]=dr^~yr&sr,i[46]=wr^~Pr&lr,i[47]=br^~Cr&mr,i[8]=Ut^~St&kt,i[9]=Vt^~xt&Bt,i[18]=jt^~Nt&_t,i[19]=Gt^~Ot&Lt,i[28]=tr^~Wt&$t,i[29]=rr^~Xt&zt,i[38]=ur^~nr&ir,i[39]=yr^~sr&or,i[48]=Pr^~lr&fr,i[49]=Cr^~mr&hr,i[0]^=Ke[l],i[1]^=Ke[l+1];};if(a)Nr.exports=ge;else {for(Ae=0;Ae<ot.length;++Ae)r[ot[Ae]]=ge[ot[Ae]];c&&define(function(){return ge});}})();});var Te=n=>`/xmtp/0/${n}/proto`,ie=(n,e)=>{let t=[utils.getAddress(n),utils.getAddress(e)];return t.sort(),Te(`dm-${t.join("-")}`)},dt=n=>Te(`m-${n}`),ut=n=>Te(`contact-${utils.getAddress(n)}`),de=n=>Te(`intro-${utils.getAddress(n)}`),Ee=n=>Te(`invite-${utils.getAddress(n)}`),Gr=n=>Te(`privatestore-${n}`),Kr=n=>Te(`userpreferences-${n}`),Wr=n=>{let e=/^[\x21-\x7F]+$/,t=n.indexOf("0/");if(t!==-1){let r=n.substring(t+2,n.lastIndexOf("/proto"));return e.test(r)}return !1};var Ar=n=>new Promise(e=>setTimeout(e,n));var ui=n=>!!n;async function Qe(n,e,t,r,s=ui,o=1){let a=typeof o=="number"?o:1;try{return await n(...e)}catch(c){if(!s(c)||a>t)throw c;return await Ar(r),Qe(n,e,t,r,s,a+1)}}async function*Xr(n,e){for await(let t of n){let r=await Promise.allSettled(t.map(e)),s=[];for(let o of r)o.status==="fulfilled"?s.push(o.value):console.warn("Failed to process envelope due to reason: ",o.reason);yield s;}}function R(n){return In.fromNumber(n.valueOf()).multiply(1e6)}function H(n){return new Date(n.divide(1e6).toNumber())}var ue=n=>n&&R(n).toString(),$r=n=>{if(n)return H(In.fromString(n))};var{b64Decode:Tr,b64Encode:Un}=fetcher;function zr(n,e){let t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function Vn(n){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,n,!0),new Uint8Array(e)}function Nn(n){let e=n.buffer;return new DataView(e).getInt32(0,!0)}var On=()=>typeof window<"u"&&typeof window.document<"u";function Er(n){let[e,t,...r]=n.split(".");return {major:Number(e),minor:Number(t),patch:r.join(".")}}function _n(n,e){return !n||!e?!0:Er(n).major===Er(e).major}function Ln(n,e){if(!n||!e)return !1;let t=Er(n),r=Er(e);return t.major!==r.major?t.major>r.major:t.minor!==r.minor?t.minor>r.minor:!t.patch||!r.patch?!1:li(t.patch,r.patch)}function li(n,e){let[t,r]=n.split("-"),[s,o]=e.split("-");if(Number(t)!==Number(s))return Number(t)>Number(s);if(!r||!o)return !1;let[a,c]=r.split("."),[p,d]=o.split(".");return a!==p?!0:Number(c)>Number(d)}function Qr(n){if(!n)return null;if(mi(n))return fi(n);if(typeof n.getAddress!="function")throw new Error("Unknown wallet type");return n}function mi(n){return "type"in n&&n.type==="walletClient"}function fi(n){let{account:e}=n;if(!e||!e.address)throw new Error("WalletClient is not configured");return {getAddress:async()=>e.address,signMessage:async t=>n.signMessage({message:typeof t=="string"?t:{raw:t},account:e})}}var L=class{topics;client;messages;resolvers;callback;subscriptionManager;onConnectionLost;constructor(e,t,r,s,o){this.messages=[],this.resolvers=[],this.topics=t,this.client=e,this.callback=this.newMessageCallback(r,s),this.onConnectionLost=o;}newMessageCallback(e,t){return async r=>{if(r.message)try{let s=await e(r);if(!s)return;if(t){let a=t(s);a&&this.resubscribeToTopics(a);}let o=this.resolvers.pop();o?o({value:s}):this.messages.unshift(s);}catch(s){console.warn(s);}}}async start(){if(!this.callback)throw new Error("Missing callback for stream");this.subscriptionManager=this.client.apiClient.subscribe({contentTopics:this.topics},async e=>{this.callback&&await this?.callback(e);},this.onConnectionLost);}static async create(e,t,r,s,o){let a=new L(e,t,r,s,o);return await a.start(),a}[Symbol.asyncIterator](){return this}async return(){return this.subscriptionManager&&await this.subscriptionManager.unsubscribe(),this.callback?(this.callback=void 0,this.resolvers.forEach(e=>e({value:void 0,done:!0})),{value:void 0,done:!0}):{value:void 0,done:!0}}next(){let e=this.messages.pop();return e?Promise.resolve({value:e}):this.callback?new Promise(t=>this.resolvers.unshift(t)):Promise.resolve({value:void 0,done:!0})}async resubscribeToTopics(e){if(!this.callback||!this.subscriptionManager)throw new Error("Missing callback for stream");if(typeof this.subscriptionManager?.updateContentTopics=="function")return this.subscriptionManager.updateContentTopics(e);await this.subscriptionManager.unsubscribe(),this.topics=e,this.subscriptionManager=this.client.apiClient.subscribe({contentTopics:this.topics},async t=>{this.callback&&await this?.callback(t);},this.onConnectionLost);}};var Yr=32,Zr=12,hi=16,U=class{aes256GcmHkdfSha256;constructor(e){if(!e.aes256GcmHkdfSha256)throw new Error("invalid ciphertext");if(e.aes256GcmHkdfSha256.payload.length<hi)throw new Error(`invalid ciphertext ciphertext length: ${e.aes256GcmHkdfSha256.payload.length}`);if(e.aes256GcmHkdfSha256.hkdfSalt.length!==Yr)throw new Error(`invalid ciphertext salt length: ${e.aes256GcmHkdfSha256.hkdfSalt.length}`);if(e.aes256GcmHkdfSha256.gcmNonce.length!==Zr)throw new Error(`invalid ciphertext nonce length: ${e.aes256GcmHkdfSha256.gcmNonce.length}`);this.aes256GcmHkdfSha256=e.aes256GcmHkdfSha256;}toBytes(){return ciphertext.Ciphertext.encode(this).finish()}static fromBytes(e){return new U(ciphertext.Ciphertext.decode(e))}};var gi=self.crypto,M=gi;var vi=new ArrayBuffer(0);async function V(n){return new Uint8Array(await M.subtle.digest("SHA-256",n))}async function ee(n,e,t){let r=M.getRandomValues(new Uint8Array(Yr)),s=M.getRandomValues(new Uint8Array(Zr)),o=await Hn(e,r),a=await M.subtle.encrypt(Fn(s,t),o,n);return new U({aes256GcmHkdfSha256:{payload:new Uint8Array(a),hkdfSalt:r,gcmNonce:s}})}async function X(n,e,t){if(!n.aes256GcmHkdfSha256)throw new Error("invalid payload ciphertext");let r=await Hn(e,n.aes256GcmHkdfSha256.hkdfSalt),s=await M.subtle.decrypt(Fn(n.aes256GcmHkdfSha256.gcmNonce,t),r,n.aes256GcmHkdfSha256.payload);return new Uint8Array(s)}function Fn(n,e){let t={name:"AES-GCM",iv:n};return e&&(t.additionalData=e),t}async function Hn(n,e){let t=await M.subtle.importKey("raw",n,"HKDF",!1,["deriveKey"]);return M.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:e,info:vi},t,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}var $=j.utils.bytesToHex;function z(n){n.startsWith("0x")&&(n=n.slice(2));let e=new Uint8Array(n.length/2);for(let t=0;t<e.length;t++){let r=t*2;e[t]=Number.parseInt(n.slice(r,r+2),16);}return e}function Se(n,e){if(n.length!==e.length)return !1;for(let t=0;t<n.length;t++)if(n[t]!==e[t])return !1;return !0}function Gn(n){if(n.bytes.length!==32)throw new Error(`invalid private key length: ${n.bytes.length}`)}var q=class{createdNs;secp256k1;publicKey;constructor(e){if(!e.secp256k1)throw new Error("invalid private key");if(Gn(e.secp256k1),this.secp256k1=e.secp256k1,this.createdNs=e.createdNs,!e.publicKey)throw new Error("missing public key");this.publicKey=new S(e.publicKey);}static async generate(e){let t={bytes:j.utils.randomPrivateKey()},r=In.fromNumber(new Date().getTime()).mul(1e6),s=new re({secp256k1Uncompressed:{bytes:j.getPublicKey(t.bytes)},createdNs:r}),o=await e.signKey(s);return new q({secp256k1:t,createdNs:r,publicKey:o})}generated(){return new Date(this.createdNs.div(1e6).toNumber())}async sign(e){let[t,r]=await j.sign(e,this.secp256k1.bytes,{recovered:!0,der:!1});return new x({ecdsaCompact:{bytes:t,recovery:r}})}async signKey(e){let t=e.toBytes(),r=await V(t),s=await this.sign(r);return new S({keyBytes:t,signature:s})}static async signerKey(e,t){let r=await V(e.bytesToSign());return en(r,t)}sharedSecret(e){return j.getSharedSecret(this.secp256k1.bytes,e.secp256k1Uncompressed.bytes,!1)}encrypt(e,t,r){let s=this.sharedSecret(t);return ee(e,s,r)}decrypt(e,t,r){let s=this.sharedSecret(t);return X(e,s,r)}matches(e){return this.publicKey.equals(e)}equals(e){return Se(this.secp256k1.bytes,e.secp256k1.bytes)&&this.publicKey.equals(e.publicKey)}toBytes(){return privateKey.SignedPrivateKey.encode(this).finish()}validatePublicKey(){let e=j.getPublicKey(this.secp256k1.bytes);return Se(e,this.publicKey.secp256k1Uncompressed.bytes)}static fromBytes(e){return new q(privateKey.SignedPrivateKey.decode(e))}static fromLegacyKey(e,t){return new q({createdNs:e.timestamp.mul(1e6),secp256k1:e.secp256k1,publicKey:S.fromLegacyKey(e.publicKey,t)})}},te=class{timestamp;secp256k1;publicKey;constructor(e){if(!e.secp256k1)throw new Error("invalid private key");if(Gn(e.secp256k1),this.timestamp=e.timestamp,this.secp256k1=e.secp256k1,!e.publicKey)throw new Error("missing public key");this.publicKey=new N(e.publicKey);}static generate(){let e={bytes:j.utils.randomPrivateKey()},t=In.fromNumber(new Date().getTime());return new te({secp256k1:e,timestamp:t,publicKey:new N({secp256k1Uncompressed:{bytes:j.getPublicKey(e.bytes)},timestamp:t})})}generated(){return new Date(this.timestamp.toNumber())}async sign(e){let[t,r]=await j.sign(e,this.secp256k1.bytes,{recovered:!0,der:!1});return new x({ecdsaCompact:{bytes:t,recovery:r}})}async signKey(e){let t=await V(e.bytesToSign());return e.signature=await this.sign(t),e}sharedSecret(e){return j.getSharedSecret(this.secp256k1.bytes,e.secp256k1Uncompressed.bytes,!1)}encrypt(e,t,r){let s=this.sharedSecret(t);return ee(e,s,r)}decrypt(e,t,r){let s=this.sharedSecret(t);return X(e,s,r)}matches(e){return this.publicKey.equals(e)}validatePublicKey(){let e=j.getPublicKey(this.secp256k1.bytes);return Se(e,this.publicKey.secp256k1Uncompressed.bytes)}toBytes(){return privateKey.PrivateKey.encode(this).finish()}static fromBytes(e){return new te(privateKey.PrivateKey.decode(e))}};function $n(n){if(n.bytes.length!==64)throw new Error(`invalid signature length: ${n.bytes.length}`);if(n.recovery!==0&&n.recovery!==1)throw new Error(`invalid recovery bit: ${n.recovery}`)}function zn(n,e){return n.recovery===e.recovery&&Se(n.bytes,e.bytes)}function en(n,e){let t=j.recoverPublicKey(n,e.bytes,e.recovery);return t?new re({secp256k1Uncompressed:{bytes:t},createdNs:In.fromNumber(0)}):void 0}var x=class{ecdsaCompact;walletEcdsaCompact;constructor(e){if(e.ecdsaCompact)$n(e.ecdsaCompact),this.ecdsaCompact=e.ecdsaCompact;else if(e.walletEcdsaCompact)$n(e.walletEcdsaCompact),this.walletEcdsaCompact=e.walletEcdsaCompact;else throw new Error("invalid signature")}async signerKey(e){return this.ecdsaCompact?q.signerKey(e,this.ecdsaCompact):this.walletEcdsaCompact?oe.signerKey(e,this.walletEcdsaCompact):void 0}getPublicKey(e){let t;if(this.ecdsaCompact)t=j.recoverPublicKey(e,this.ecdsaCompact.bytes,this.ecdsaCompact.recovery);else if(this.walletEcdsaCompact)t=j.recoverPublicKey(e,this.walletEcdsaCompact.bytes,this.walletEcdsaCompact.recovery);else throw new Error("invalid v1 signature");return t?new N({secp256k1Uncompressed:{bytes:t},timestamp:In.fromNumber(0)}):void 0}equals(e){return this.ecdsaCompact&&e.ecdsaCompact?zn(this.ecdsaCompact,e.ecdsaCompact):this.walletEcdsaCompact&&e.walletEcdsaCompact?zn(this.walletEcdsaCompact,e.walletEcdsaCompact):!1}toBytes(){return signature.Signature.encode(this).finish()}static fromBytes(e){return new x(signature.Signature.decode(e))}};var oe=class{wallet;constructor(e){this.wallet=e;}static identitySigRequestText(e){return `XMTP : Create Identity
 ${$(e)}
 
 For more info: https://xmtp.org/signatures/`}static signerKey(e,t){let r=z(utils.hashMessage(this.identitySigRequestText(e.bytesToSign())));return en(r,t)}async signKey(e){let t=e.toBytes(),r=await this.wallet.signMessage(oe.identitySigRequestText(t)),s=utils.splitSignature(r),o=z(s.r),a=z(s.s),c=new Uint8Array(64);c.set(o),c.set(a,o.length);let p=new x({walletEcdsaCompact:{bytes:c,recovery:s.recoveryParam}});return new S({keyBytes:t,signature:p})}};function Pi(n){if(n.bytes.length!==65)throw new Error(`invalid public key length: ${n.bytes.length}`);if(n.bytes[0]!==4)throw new Error(`unrecognized public key prefix: ${n.bytes[0]}`)}var Ci=new In(10**9).mul(10**9),re=class{createdNs;secp256k1Uncompressed;constructor(e){if(!e?.secp256k1Uncompressed)throw new Error("invalid public key");Pi(e.secp256k1Uncompressed),this.secp256k1Uncompressed=e.secp256k1Uncompressed,this.createdNs=e.createdNs.toUnsigned();}generated(){return new Date(this.timestamp.toNumber())}isFromLegacyKey(){return this.createdNs.lessThan(Ci)}get timestamp(){return (this.isFromLegacyKey()?this.createdNs:this.createdNs.div(1e6)).toUnsigned()}verify(e,t){return e.ecdsaCompact?j.verify(e.ecdsaCompact.bytes,t,this.secp256k1Uncompressed.bytes):!1}async verifyKey(e){if(!e.signature)return !1;let t=await V(e.bytesToSign());return this.verify(e.signature,t)}equals(e){return Se(this.secp256k1Uncompressed.bytes,e.secp256k1Uncompressed.bytes)}getEthereumAddress(){return utils.computeAddress(this.secp256k1Uncompressed.bytes)}toBytes(){return publicKey.UnsignedPublicKey.encode(this).finish()}static fromBytes(e){return new re(publicKey.UnsignedPublicKey.decode(e))}},S=class extends re{keyBytes;signature;constructor(e){if(!e.keyBytes)throw new Error("missing key bytes");if(super(publicKey.UnsignedPublicKey.decode(e.keyBytes)),this.keyBytes=e.keyBytes,!e.signature)throw new Error("missing key signature");this.signature=new x(e.signature);}get unsignedKey(){return new re({createdNs:this.createdNs,secp256k1Uncompressed:this.secp256k1Uncompressed})}signerKey(){return this.signature.signerKey(this)}async walletSignatureAddress(){if(!this.signature.walletEcdsaCompact)throw new Error("key was not signed by a wallet");let e=await this.signerKey();if(!e)throw new Error("key signature not valid");return e.getEthereumAddress()}equals(e){return this.unsignedKey.equals(e.unsignedKey)&&this.signature.equals(e.signature)}bytesToSign(){return this.keyBytes}toBytes(){return publicKey.SignedPublicKey.encode(this).finish()}static fromBytes(e){return new S(publicKey.SignedPublicKey.decode(e))}toLegacyKey(){if(!this.isFromLegacyKey())throw new Error("cannot be converted to legacy key");let e=this.signature;return e.walletEcdsaCompact&&(e=new x({ecdsaCompact:e.walletEcdsaCompact})),new N({timestamp:this.timestamp,secp256k1Uncompressed:this.secp256k1Uncompressed,signature:e})}static fromLegacyKey(e,t){if(!e.signature)throw new Error("key is not signed");let r=e.signature;return t&&(r=new x({walletEcdsaCompact:r.ecdsaCompact})),new S({keyBytes:e.bytesToSign(),signature:r})}},N=class extends re{signature;constructor(e){super({createdNs:e.timestamp.mul(1e6),secp256k1Uncompressed:e.secp256k1Uncompressed}),e.signature&&(!e.signature.ecdsaCompact&&e.signature.walletEcdsaCompact?this.signature=new x({ecdsaCompact:{bytes:e.signature.walletEcdsaCompact.bytes,recovery:e.signature.walletEcdsaCompact.recovery}}):this.signature=new x(e.signature));}get timestamp(){return this.createdNs.div(1e6)}bytesToSign(){return publicKey.PublicKey.encode({timestamp:this.timestamp,secp256k1Uncompressed:this.secp256k1Uncompressed}).finish()}async signWithWallet(e){let t=await e.signMessage(oe.identitySigRequestText(this.bytesToSign())),r=utils.splitSignature(t),s=z(r.r),o=z(r.s),a=new Uint8Array(64);a.set(s),a.set(o,s.length),this.signature=new x({ecdsaCompact:{bytes:a,recovery:r.recoveryParam}});}walletSignatureAddress(){if(!this.signature)throw new Error("key is not signed");let e=z(utils.hashMessage(oe.identitySigRequestText(this.bytesToSign()))),t=this.signature.getPublicKey(e);if(!t)throw new Error("key signature is malformed");return t.getEthereumAddress()}toBytes(){return publicKey.PublicKey.encode(this).finish()}static fromBytes(e){return new N(publicKey.PublicKey.decode(e))}};var T=class{identityKey;preKey;constructor(e){if(!e.identityKey)throw new Error("missing identity key");if(!e.preKey)throw new Error("missing pre-key");this.identityKey=new S(e.identityKey),this.preKey=new S(e.preKey);}walletSignatureAddress(){return this.identityKey.walletSignatureAddress()}equals(e){return this.identityKey.equals(e.identityKey)&&this.preKey.equals(e.preKey)}toBytes(){return publicKey.SignedPublicKeyBundle.encode(this).finish()}isFromLegacyBundle(){return this.identityKey.isFromLegacyKey()&&this.preKey.isFromLegacyKey()}toLegacyBundle(){return new P({identityKey:this.identityKey.toLegacyKey(),preKey:this.preKey.toLegacyKey()})}static fromBytes(e){let t=publicKey.SignedPublicKeyBundle.decode(e);return new T(t)}static fromLegacyBundle(e){return new T({identityKey:S.fromLegacyKey(e.identityKey,!0),preKey:S.fromLegacyKey(e.preKey)})}},P=class{identityKey;preKey;constructor(e){if(!e.identityKey)throw new Error("missing identity key");if(!e.preKey)throw new Error("missing pre-key");this.identityKey=new N(e.identityKey),this.preKey=new N(e.preKey);}equals(e){return this.identityKey.equals(e.identityKey)&&this.preKey.equals(e.preKey)}walletSignatureAddress(){return this.identityKey.walletSignatureAddress()}toBytes(){return publicKey.PublicKeyBundle.encode(this).finish()}static fromBytes(e){let t=publicKey.PublicKeyBundle.decode(e);return new P(t)}};var yt=class extends Error{constructor(e){super(`no pre-key matches: ${$(e.secp256k1Uncompressed.bytes)}`);}};var G=class{identityKey;preKeys;version=2;_publicKeyBundle;constructor(e){if(!e.identityKey)throw new Error("missing identity key");this.identityKey=new q(e.identityKey),this.preKeys=(e.preKeys||[]).map(t=>new q(t));}static async generate(e){let t=await q.generate(new oe(e)),r=new G({identityKey:t,preKeys:[]});return await r.addPreKey(),r}getCurrentPreKey(){return this.preKeys[0]}findPreKey(e){let t=this.preKeys.find(r=>r.matches(e));if(!t)throw new yt(e);return t}async addPreKey(){this._publicKeyBundle=void 0;let e=await q.generate(this.identityKey);this.preKeys.unshift(e);}getPublicKeyBundle(){return this._publicKeyBundle||(this._publicKeyBundle=new T({identityKey:this.identityKey.publicKey,preKey:this.getCurrentPreKey().publicKey})),this._publicKeyBundle}async sharedSecret(e,t,r){if(!e.identityKey||!e.preKey)throw new Error("invalid peer key bundle");if(!await e.identityKey.verifyKey(e.preKey))throw new Error("peer preKey signature invalid");if(!this.identityKey)throw new Error("missing identity key");let s,o,a;r?(a=this.findPreKey(t),s=a.sharedSecret(e.identityKey),o=this.identityKey.sharedSecret(e.preKey)):(a=this.findPreKey(t),s=this.identityKey.sharedSecret(e.preKey),o=a.sharedSecret(e.identityKey));let c=a.sharedSecret(e.preKey),p=new Uint8Array(s.length+o.length+c.length);return p.set(s,0),p.set(o,s.length),p.set(c,s.length+o.length),p}encode(){return privateKey.PrivateKeyBundle.encode({v1:void 0,v2:this}).finish()}validatePublicKeys(){return this.identityKey.validatePublicKey()?this.preKeys.every(e=>e.validatePublicKey()):!1}equals(e){if(this.preKeys.length!==e.preKeys.length)return !1;for(let t=0;t<this.preKeys.length;t++)if(!this.preKeys[t].equals(e.preKeys[t]))return !1;return this.identityKey.equals(e.identityKey)}static fromLegacyBundle(e){return new G({identityKey:q.fromLegacyKey(e.identityKey,!0),preKeys:e.preKeys.map(t=>q.fromLegacyKey(t))})}},O=class{identityKey;preKeys;version=1;_publicKeyBundle;constructor(e){if(!e.identityKey)throw new Error("missing identity key");this.identityKey=new te(e.identityKey),this.preKeys=(e.preKeys||[]).map(t=>new te(t));}static async generate(e){let t=te.generate();e&&await t.publicKey.signWithWallet(e);let r=new O({identityKey:t,preKeys:[]});return await r.addPreKey(),r}getCurrentPreKey(){return this.preKeys[0]}findPreKey(e){let t=this.preKeys.find(r=>r.matches(e));if(!t)throw new yt(e);return t}async addPreKey(){this._publicKeyBundle=void 0;let e=te.generate();await this.identityKey.signKey(e.publicKey),this.preKeys.unshift(e);}getPublicKeyBundle(){return this._publicKeyBundle||(this._publicKeyBundle=new P({identityKey:this.identityKey.publicKey,preKey:this.getCurrentPreKey().publicKey})),this._publicKeyBundle}validatePublicKeys(){return this.identityKey.validatePublicKey()?this.preKeys.every(e=>e.validatePublicKey()):!1}async sharedSecret(e,t,r){if(!e.identityKey||!e.preKey)throw new Error("invalid peer key bundle");if(!await e.identityKey.verifyKey(e.preKey))throw new Error("peer preKey signature invalid");if(!this.identityKey)throw new Error("missing identity key");let s,o,a;r?(a=this.findPreKey(t),s=a.sharedSecret(e.identityKey),o=this.identityKey.sharedSecret(e.preKey)):(a=this.findPreKey(t),s=this.identityKey.sharedSecret(e.preKey),o=a.sharedSecret(e.identityKey));let c=a.sharedSecret(e.preKey),p=new Uint8Array(s.length+o.length+c.length);return p.set(s,0),p.set(o,s.length),p.set(c,s.length+o.length),p}encode(){return privateKey.PrivateKeyBundle.encode({v1:this,v2:void 0}).finish()}};function Ve(n){let e=privateKey.PrivateKeyBundle.decode(n);if(e.v1)return new O(e.v1);if(e.v2)return new G(e.v2);throw new Error("unknown private key bundle version")}var Ki=16,Ai=65,Ti=32,Ei=16,Si=n=>{if(n.iv.length!==Ki)throw new Error("Invalid iv length");if(n.ephemeralPublicKey.length!==Ai)throw new Error("Invalid ephemPublicKey length");if(n.ciphertext.length<1||n.ciphertext.length%Ei!==0)throw new Error("Invalid ciphertext length");if(n.mac.length!==Ti)throw new Error("Invalid mac length")},ye=class{eciesBytes;signature;ciphertext;constructor({eciesBytes:e,signature:t}){if(!e||!e.length)throw new Error("eciesBytes is empty");if(!t)throw new Error("signature is undefined");this.eciesBytes=e,this.signature=new x(t),this.ciphertext=ciphertext.SignedEciesCiphertext_Ecies.decode(e);}toBytes(){return ciphertext.SignedEciesCiphertext.encode(this).finish()}async verify(e){return e.verify(this.signature,await V(this.eciesBytes))}static fromBytes(e){let t=ciphertext.SignedEciesCiphertext.decode(e);return new ye(t)}static async create(e,t){Si(e);let r=ciphertext.SignedEciesCiphertext_Ecies.encode(e).finish(),s=await t.sign(await V(r));return new ye({eciesBytes:r,signature:s})}};var lt=class{messageEnvelope;onSend;constructor(e,t){this.messageEnvelope=e,this.onSend=t;}async messageID(){if(!this.messageEnvelope.message)throw new Error("no envelope message");return $(await V(this.messageEnvelope.message))}async send(){return this.onSend()}};var C=class extends Error{code;constructor(e,t){super(t),this.code=e;}};var Ne=n=>{if(n.error)throw new C(n.error.code,n.error.message);if(!n.result)throw new C(keystore.ErrorCode.ERROR_CODE_UNSPECIFIED,"No result from Keystore");if("encrypted"in n.result&&!n.result.encrypted)throw new Error("Missing ciphertext");if("decrypted"in n.result&&!n.result.decrypted)throw new Error("Missing decrypted result");return n.result},Mr=(n,e)=>({requests:n.map(t=>{let r=new P({identityKey:t.header.sender?.identityKey,preKey:t.header.sender?.preKey}),s=e.equals(r);return {payload:t.ciphertext,peerKeys:s?new P({identityKey:t.header.recipient?.identityKey,preKey:t.header.recipient?.preKey}):r,headerBytes:t.headerBytes,isSender:s}})});var Q=class{authorityId;typeId;versionMajor;versionMinor;constructor(e){this.authorityId=e.authorityId,this.typeId=e.typeId,this.versionMajor=e.versionMajor,this.versionMinor=e.versionMinor;}toString(){return `${this.authorityId}/${this.typeId}:${this.versionMajor}.${this.versionMinor}`}static fromString(e){let[t,r]=e.split(":"),[s,o]=t.split("/"),[a,c]=r.split(".");return new Q({authorityId:s,typeId:o,versionMajor:Number(a),versionMinor:Number(c)})}sameAs(e){return this.authorityId===e.authorityId&&this.typeId===e.typeId}},ki=new Q({authorityId:"xmtp.org",typeId:"fallback",versionMajor:1,versionMinor:0});var le=new Q({authorityId:"xmtp.org",typeId:"text",versionMajor:1,versionMinor:0});var mt=class{get contentType(){return le}encode(e){return {type:le,parameters:{encoding:"UTF-8"},content:new TextEncoder().encode(e)}}decode(e){let t=e.parameters.encoding;if(t&&t!=="UTF-8")throw new Error(`unrecognized encoding ${t}`);return new TextDecoder().decode(e.content)}fallback(e){}};var Y=class{conversationVersion="v1";peerAddress;createdAt;context=void 0;client;constructor(e,t,r){this.peerAddress=utils.getAddress(t),this.client=e,this.createdAt=r;}get clientAddress(){return this.client.address}async allow(){await this.client.contacts.allow([this.peerAddress]);}async deny(){await this.client.contacts.deny([this.peerAddress]);}get isAllowed(){return this.client.contacts.isAllowed(this.peerAddress)}get isDenied(){return this.client.contacts.isDenied(this.peerAddress)}get consentState(){return this.client.contacts.consentState(this.peerAddress)}get topic(){return ie(this.peerAddress,this.client.address)}get ephemeralTopic(){return ie(this.peerAddress,this.client.address).replace("/xmtp/0/dm-","/xmtp/0/dmE-")}async messages(e){let t=ie(this.peerAddress,this.client.address),r=await this.client.listEnvelopes(t,this.processEnvelope.bind(this),e);return this.decryptBatch(r,t,!1)}messagesPaginated(e){return this.client.listEnvelopesPaginated(this.topic,this.decodeMessage.bind(this),e)}async decodeMessage(e){if(!e.contentTopic)throw new Error("Missing content topic");let t=await this.processEnvelope(e),r=await this.decryptBatch([t],e.contentTopic,!0);if(!r.length)throw new Error("No results");return r[0]}async prepareMessage(e,t){let r,s=await this.client.getUserContact(this.peerAddress);if(!s)throw new Error(`recipient ${this.peerAddress} is not registered`);s instanceof P||(s=s.toLegacyBundle());let o=t?.ephemeral?this.ephemeralTopic:this.topic;this.client.contacts.addresses.has(this.peerAddress)?r=[o]:(r=[de(this.peerAddress),de(this.client.address),o],this.client.contacts.addresses.add(this.peerAddress));let a=await this.client.encodeContent(e,t),c=await this.createMessage(a,s,t?.timestamp),p=c.toBytes(),d={contentTopic:o,message:p,timestampNs:ue(c.sent)};return new lt(d,async()=>(await this.client.publishEnvelopes(r.map(f=>({contentTopic:f,message:p,timestamp:c.sent}))),_.fromV1Message(c,e,t?.contentType||le,a,o,this)))}streamMessages(e){return L.create(this.client,[this.topic],async t=>this.decodeMessage(t),void 0,e)}async processEnvelope({message:e,contentTopic:t}){if(!e||!e.length)throw new Error("empty envelope");let r=await W.fromBytes(e),{senderAddress:s,recipientAddress:o}=r;if(!s||!o||!t||ie(s,o)!==this.topic)throw new Error("Headers do not match intended recipient");return r}streamEphemeral(e){return L.create(this.client,[this.ephemeralTopic],this.decodeMessage.bind(this),void 0,e)}async send(e,t){let r,s=await this.client.getUserContact(this.peerAddress);if(!s)throw new Error(`recipient ${this.peerAddress} is not registered`);s instanceof P||(s=s.toLegacyBundle());let o=t?.ephemeral?this.ephemeralTopic:this.topic;this.client.contacts.addresses.has(this.peerAddress)?r=[o]:(r=[de(this.peerAddress),de(this.client.address),o],this.client.contacts.addresses.add(this.peerAddress));let a=t?.contentType||le,c=await this.client.encodeContent(e,t),p=await this.createMessage(c,s,t?.timestamp);return await this.client.publishEnvelopes(r.map(d=>({contentTopic:d,message:p.toBytes(),timestamp:p.sent}))),this.consentState==="unknown"&&await this.allow(),_.fromV1Message(p,e,a,c,o,this)}async decryptBatch(e,t,r=!1){let s=(await this.client.keystore.decryptV1(Mr(e,this.client.publicKeyBundle))).responses,o=[];for(let a=0;a<s.length;a++){let c=s[a],p=e[a];try{let{decrypted:d}=Ne(c);o.push(await this.buildDecodedMessage(p,d,t));}catch(d){if(r)throw d;console.warn("Error decoding content",d);}}return o}async buildDecodedMessage(e,t,r){let{content:s,contentType:o,error:a,contentFallback:c}=await this.client.decodeContent(t);return _.fromV1Message(e,s,o,t,r,this,a,c)}async createMessage(e,t,r){return r=r||new Date,W.encode(this.client.keystore,e,this.client.publicKeyBundle,t,r)}},ae=class{conversationVersion="v2";client;topic;peerAddress;createdAt;context;constructor(e,t,r,s,o){this.topic=t,this.createdAt=s,this.context=o,this.client=e,this.peerAddress=r;}get clientAddress(){return this.client.address}async allow(){await this.client.contacts.allow([this.peerAddress]);}async deny(){await this.client.contacts.deny([this.peerAddress]);}get isAllowed(){return this.client.contacts.isAllowed(this.peerAddress)}get isDenied(){return this.client.contacts.isDenied(this.peerAddress)}get consentState(){return this.client.contacts.consentState(this.peerAddress)}async messages(e){let t=await this.client.listEnvelopes(this.topic,this.processEnvelope.bind(this),e);return this.decryptBatch(t,!1)}messagesPaginated(e){return this.client.listEnvelopesPaginated(this.topic,this.decodeMessage.bind(this),e)}get ephemeralTopic(){return this.topic.replace("/xmtp/0/m","/xmtp/0/mE")}streamEphemeral(e){return L.create(this.client,[this.ephemeralTopic],this.decodeMessage.bind(this),void 0,e)}streamMessages(e){return L.create(this.client,[this.topic],this.decodeMessage.bind(this),void 0,e)}async send(e,t){let r=await this.client.encodeContent(e,t),s=await this.createMessage(r,t?.timestamp),o=t?.ephemeral?this.ephemeralTopic:this.topic;await this.client.publishEnvelopes([{contentTopic:o,message:s.toBytes(),timestamp:s.sent}]);let a=t?.contentType||le;return this.consentState==="unknown"&&await this.allow(),_.fromV2Message(s,e,a,o,r,this,this.client.address)}async createMessage(e,t){let r={topic:this.topic,createdNs:R(t||new Date)},s=message.MessageHeaderV2.encode(r).finish(),o=await V(zr(s,e)),a={payload:e,sender:this.client.signedPublicKeyBundle,signature:await this.client.keystore.signDigest({digest:o,prekeyIndex:0,identityKey:void 0})},c=content.SignedContent.encode(a).finish(),p=await this.encryptMessage(c,s),d={v1:void 0,v2:{headerBytes:s,ciphertext:p}},f=message.Message.encode(d).finish();return ke.create(d,r,f)}async decryptBatch(e,t=!1){let r=(await this.client.keystore.decryptV2(this.buildDecryptRequest(e))).responses,s=[];for(let o=0;o<r.length;o++){let a=r[o],c=e[o];try{let{decrypted:p}=Ne(a);s.push(await this.buildDecodedMessage(c,p));}catch(p){if(t)throw p;console.warn("Error decoding content",p);}}return s}buildDecryptRequest(e){return {requests:e.map(t=>({payload:t.ciphertext,headerBytes:t.headerBytes,contentTopic:this.topic}))}}async encryptMessage(e,t){let{responses:r}=await this.client.keystore.encryptV2({requests:[{payload:e,headerBytes:t,contentTopic:this.topic}]});if(r.length!==1)throw new Error("Invalid response length");let{encrypted:s}=Ne(r[0]);return s}async buildDecodedMessage(e,t){let r=content.SignedContent.decode(t);if(!r.sender?.identityKey||!r.sender?.preKey||!r.signature)throw new Error("incomplete signed content");await Mi(r);let s=await V(zr(e.headerBytes,r.payload));if(!new S(r.sender?.preKey).verify(new x(r.signature),s))throw new Error("invalid signature");let o=await new T(r.sender).walletSignatureAddress(),{content:a,contentType:c,error:p,contentFallback:d}=await this.client.decodeContent(r.payload);return _.fromV2Message(e,a,c,this.topic,r.payload,this,o,p,d)}async prepareMessage(e,t){let r=await this.client.encodeContent(e,t),s=await this.createMessage(r,t?.timestamp),o=s.toBytes(),a=t?.ephemeral?this.ephemeralTopic:this.topic,c={contentTopic:a,message:o,timestampNs:ue(s.sent)};return new lt(c,async()=>(await this.client.publishEnvelopes([{contentTopic:a,message:o,timestamp:s.sent}]),_.fromV2Message(s,e,t?.contentType||le,a,r,this,this.client.address)))}async processEnvelope(e){if(!e.message||!e.contentTopic)throw new Error("empty envelope");let t=message.Message.decode(e.message);if(!t.v2)throw new Error("unknown message version");let r=message.MessageHeaderV2.decode(t.v2.headerBytes);if(r.topic!==this.topic)throw new Error("topic mismatch");return ke.create(t,r,e.message)}async decodeMessage(e){if(!e.contentTopic)throw new Error("Missing content topic");let t=await this.processEnvelope(e),r=await this.decryptBatch([t],!0);if(!r.length)throw new Error("No results");return r[0]}};async function Mi(n){let e=n.sender?.preKey;if(!e||!e.signature||!e.keyBytes)throw new Error("missing pre-key or pre-key signature");let t=n.sender?.identityKey;if(!t)throw new Error("missing identity key in bundle");if(!await new S(t).verifyKey(new S(e)))throw new Error("pre key not signed by identity key")}var es=n=>{if(n.v1?.ciphertext)return [n.v1.headerBytes,new U(n.v1.ciphertext)];if(n.v2?.ciphertext)return [n.v2.headerBytes,new U(n.v2.ciphertext)];throw new Error("unknown message version")},Dr=class{headerBytes;ciphertext;contentType;error;id;bytes;constructor(e,t,r){[this.headerBytes,this.ciphertext]=es(r),this.id=e,this.bytes=t;}toBytes(){return this.bytes}},W=class extends Dr{header;senderAddress;conversation=void 0;constructor(e,t,r,s,o){super(e,t,r),this.senderAddress=o,this.header=s;}static async create(e,t,r){if(!t.sender)throw new Error("missing message sender");let s=new P(t.sender).walletSignatureAddress(),o=$(await V(r));return new W(o,r,e,t,s)}get sent(){return new Date(this.header.timestamp.toNumber())}get recipientAddress(){if(this.header?.recipient?.identityKey)return new N(this.header.recipient.identityKey).walletSignatureAddress()}async decrypt(e,t){let r=(await e.decryptV1(Mr([this],t))).responses;if(!r.length)throw new Error("No response from Keystore");let{decrypted:s}=Ne(r[0]);return s}static fromBytes(e){let t=message.Message.decode(e),[r]=es(t),s=message.MessageHeaderV1.decode(r);if(!s)throw new Error("missing message header");if(!s.sender)throw new Error("missing message sender");if(!s.sender.identityKey)throw new Error("missing message sender identity key");if(!s.sender.preKey)throw new Error("missing message sender pre-key");if(!s.recipient)throw new Error("missing message recipient");if(!s.recipient.identityKey)throw new Error("missing message recipient identity-key");if(!s.recipient.preKey)throw new Error("missing message recipient pre-key");return W.create(t,s,e)}static async encode(e,t,r,s,o){let a={sender:r,recipient:s,timestamp:In.fromNumber(o.getTime())},c=message.MessageHeaderV1.encode(a).finish(),p=await e.encryptV1({requests:[{recipient:s,headerBytes:c,payload:t}]});if(!p.responses.length)throw new Error("No response from Keystore");let{encrypted:d}=Ne(p.responses[0]),f={v1:{headerBytes:c,ciphertext:d},v2:void 0},w=message.Message.encode(f).finish();return W.create(f,a,w)}},ke=class extends Dr{senderAddress;header;constructor(e,t,r,s){super(e,t,r),this.header=s;}static async create(e,t,r){let s=$(await V(r));return new ke(s,r,e,t)}get sent(){return H(this.header.createdNs)}},_=class{id;messageVersion;senderAddress;recipientAddress;sent;contentTopic;conversation;contentType;content;error;contentBytes;contentFallback;constructor({id:e,messageVersion:t,senderAddress:r,recipientAddress:s,conversation:o,contentBytes:a,contentType:c,contentTopic:p,content:d,sent:f,error:w,contentFallback:A}){this.id=e,this.messageVersion=t,this.senderAddress=r,this.recipientAddress=s,this.conversation=o,this.contentType=c,this.sent=f,this.error=w,this.content=d,this.contentTopic=p,this.contentBytes=a,this.contentFallback=A;}toBytes(){return message.DecodedMessage.encode({...this,conversation:{topic:this.conversation.topic,context:this.conversation.context??void 0,createdNs:R(this.conversation.createdAt),peerAddress:this.conversation.peerAddress},sentNs:R(this.sent)}).finish()}static async fromBytes(e,t){let r=message.DecodedMessage.decode(e),s=r.messageVersion;if(s!=="v1"&&s!=="v2")throw new Error("Invalid message version");if(!r.conversation)throw new Error("No conversation reference found");let{content:o,contentType:a,error:c,contentFallback:p}=await t.decodeContent(r.contentBytes);return new _({...r,content:o,contentType:a,error:c,messageVersion:s,sent:H(r.sentNs),conversation:Di(r.conversation,t,s),contentFallback:p})}static fromV1Message(e,t,r,s,o,a,c,p){let{id:d,senderAddress:f,recipientAddress:w,sent:A}=e;if(!f)throw new Error("Sender address is required");return new _({id:d,messageVersion:"v1",senderAddress:f,recipientAddress:w,sent:A,content:t,contentBytes:s,contentType:r,contentTopic:o,conversation:a,error:c,contentFallback:p})}static fromV2Message(e,t,r,s,o,a,c,p,d){let{id:f,sent:w}=e;return new _({id:f,messageVersion:"v2",senderAddress:c,sent:w,content:t,contentBytes:o,contentType:r,contentTopic:s,conversation:a,error:p,contentFallback:d})}};function Di(n,e,t){if(t==="v1")return new Y(e,n.peerAddress,H(n.createdNs));if(t==="v2")return new ae(e,n.topic,n.peerAddress,H(n.createdNs),n.context);throw new Error(`Unknown conversation version ${t}`)}function Ii(n,e){return e.decodeContent(n)}var Ui=60*60-10,Oe=class{authenticator;token;maxAgeMs;constructor(e,t=Ui){this.authenticator=e,this.maxAgeMs=t*1e3;}async getToken(){return (!this.token||this.token.ageMs>this.maxAgeMs)&&await this.refresh(),this.token.toBase64()}async refresh(){this.token=await this.authenticator.createToken();}};var ts={name:"@xmtp/xmtp-js",version:"11.3.0",description:"XMTP client SDK for interacting with XMTP networks.",type:"module",main:"dist/index.cjs",module:"dist/index.js",types:"dist/index.d.ts",browser:"dist/web/index.js",exports:{".":{types:"./dist/index.d.ts",browser:"./dist/web/index.js",import:"./dist/index.js",require:"./dist/index.cjs"},"./node":{types:"./dist/index.d.ts",import:"./dist/index.js",require:"./dist/index.cjs"},"./node/esm":{types:"./dist/index.d.ts",default:"./dist/index.js"},"./node/cjs":{types:"./dist/index.d.ts",default:"./dist/index.cjs"},"./browser":{types:"./dist/index.d.ts",default:"./dist/web/index.js"},"./browser/bundler":{types:"./dist/index.d.ts",default:"./dist/bundler/index.js"}},scripts:{prebench:"npm run build:bench",bench:"node dist/bench/index.cjs",build:"npm run clean:dist && npm run build:node && npm run build:web && npm run build:bundler","build:bench":"tsup --out-dir dist/bench --entry.0 bench/index.ts --format cjs","build:node":"tsup","build:web":"tsup --platform browser --target esnext","build:bundler":"tsup --config tsup.bundler.config.ts","build:docs":"rimraf docs && mkdir -p tmp && cp README.md tmp/ && sed -i.bak '/badge.svg/d' tmp/README.md && typedoc --excludePrivate --readme tmp/README.md src/index.ts",clean:"npm run clean:dist && npm run clean:proto","clean:dist":"rimraf dist","clean:proto":"rimraf -g src/proto/*.ts",package:"npm pack",prepublishOnly:"npm run build",updateSnapVersion:`npm view @xmtp/snap --json | jq '{"version": .version, "package": .name}' > ./src/snapInfo.json`,"test:setup":"./dev/up","test:teardown":"./dev/down",test:"npm run test:node --","test:node":"jest --no-cache --env='node' --testTimeout=30000","test:jsdom":"jest --no-cache --env='./jest.jsdom.env.cjs' --testTimeout=30000","test:cov":"jest --coverage --no-cache --runInBand",lint:"prettier --check . && eslint .",autolint:"prettier --write . && eslint --fix .","semantic-release":"semantic-release",typecheck:"tsc"},publishConfig:{access:"public",provenance:!0},files:["dist/index.cjs","dist/index.cjs.map","dist/index.d.ts","dist/index.js","dist/index.js.map","dist/web/index.js","dist/web/index.js.map"],keywords:["xmtp","messaging","web3","sdk","js","javascript","node","nodejs"],author:"XMTP Labs <eng@xmtp.com>",license:"MIT",homepage:"https://github.com/xmtp/xmtp-js",repository:{type:"git",url:"https:git@github.com:xmtp/xmtp-js.git"},bugs:{url:"https://github.com/xmtp/xmtp-js/issues"},release:{branches:["main",{name:"beta",prerelease:!0}]},dependencies:{"@noble/secp256k1":"^1.5.2","@xmtp/proto":"^3.34.0","@xmtp/user-preferences-bindings-wasm":"^0.3.4","async-mutex":"^0.4.0",elliptic:"^6.5.4",ethers:"^5.5.3",long:"^5.2.0"},devDependencies:{"@commitlint/cli":"^17.7.1","@commitlint/config-conventional":"^16.0.0","@metamask/providers":"^11.1.1","@types/benchmark":"^2.1.2","@types/bl":"^5.0.2","@types/callback-to-async-iterator":"^1.1.4","@types/elliptic":"^6.4.14","@types/jest":"^28.1.3","@types/node":"^18.14.0","@typescript-eslint/eslint-plugin":"^6.7.2","@typescript-eslint/parser":"^6.7.2",benny:"^3.7.1","dd-trace":"^2.12.2",esbuild:"^0.17.16",eslint:"^8.50.0","eslint-config-prettier":"^9.0.0","eslint-config-standard":"^17.1.0","eslint-plugin-import":"^2.28.1","eslint-plugin-jsdoc":"^46.8.2","eslint-plugin-node":"^11.1.0","eslint-plugin-prettier":"^5.0.0","eslint-plugin-promise":"^6.1.1","find-up":"^7.0.0",husky:"^7.0.4",jest:"^29.6.0","jest-environment-jsdom":"^28.1.3",prettier:"^3.0.3",rimraf:"^5.0.0","semantic-release":"^21.0.3","ts-jest":"^29.1.1","ts-node":"^10.9.1",tsup:"^6.7.0",typedoc:"^0.25.1",typescript:"^5.2.2",viem:"^1.12.1"},engines:{node:">=18"}};var rs=`
